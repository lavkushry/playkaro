# NGINX RTMP Configuration Example
# Place this in /etc/nginx/nginx.conf or include it

rtmp {
    server {
        listen 1935;
        chunk_size 4096;

        # Live streaming application
        application live {
            live on;
            record off;

            # Authentication webhook
            on_publish http://streaming-service:8085/v1/streaming/hooks/on_publish;
            on_publish_done http://streaming-service:8085/v1/streaming/hooks/on_publish_done;

            # Viewer tracking
            on_play http://streaming-service:8085/v1/streaming/hooks/on_play;
            on_play_done http://streaming-service:8085/v1/streaming/hooks/on_play_done;

            # HLS output
            hls on;
            hls_path /tmp/hls;
            hls_fragment 3s;
            hls_playlist_length 10s;

            # Multiple bitrates (adaptive streaming)
            exec ffmpeg -i rtmp://localhost:1935/live/$name
                -c:v libx264 -preset veryfast -tune zerolatency
                -c:a aac -b:a 128k
                -vf scale=1280:720 -b:v 2500k -maxrate 2500k -bufsize 5000k -f flv rtmp://localhost:1935/hls/$name_720p
                -vf scale=854:480 -b:v 1000k -maxrate 1000k -bufsize 2000k -f flv rtmp://localhost:1935/hls/$name_480p
                -vf scale=640:360 -b:v 500k -maxrate 500k -bufsize 1000k -f flv rtmp://localhost:1935/hls/$name_360p;
        }

        # HLS delivery application
        application hls {
            live on;
            hls on;
            hls_path /tmp/hls;
            hls_fragment 3s;
            hls_playlist_length 10s;
        }
    }
}

# HTTP server to serve HLS playlists
http {
    server {
        listen 8080;

        location /hls {
            types {
                application/vnd.apple.mpegurl m3u8;
                video/mp2t ts;
            }
            root /tmp;
            add_header Cache-Control no-cache;
            add_header Access-Control-Allow-Origin *;
        }
    }
}
